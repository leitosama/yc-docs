# Использование Ansible с сервисной учетной записью и функцией OS Login
При использовании Ansible как инструмента Infrastructure as a Code вам может потребоваться сервисная учетная запись для управления ВМ.
Создав сервисную учетную запись внутри Yandex Cloud и используя механизм OS Login мы можем получить следующее: 
* Отдельную учетную запись для управления ВМ с помощью Ansible. Подключение по SSH в данном случае осуществляется под пользователем `yc-sa-<имя_сервисной_учетной_записи>`, где `<имя_сервисной_учетной_записи>` - имя сервисной учетной записи в Yandex Cloud
* Возможность добавления SSH-ключей к учетной записи и его отзыва по времени или вручную
* Возможность поднятия привилегий без использования пароля при назначении роли `compute.osLoginAdmin`. Данная функция может понадобиться в случае использования директивы `become` в задачах Ansible

Для настройки сервисной учетную запись для Ansible:
1. [Добавьте ключи к сервисной учетной записи](#create-ssh-key)
1. [Настройте Ansible для работы с созданным ключом и сервисной учетной записью](#check-ansible)

## Перед началом работы {#before-begin}

1. [Создайте сервисный аккаунт](../../iam/operations/sa/create.md) c ролью `compute.osAdminLogin`
1. [Создайте ВМ](../../compute/operations/vm-create/create-linux-vm.md) из публичного образа c функционалом OS Login, например, [Ubuntu 22.04 LTS](/marketplace/products/yc/ubuntu-2204-lts-oslogin)

## Добавление ключей к сервисной учетной записи {#create-ssh-key}

1. Создайте пару ключей типа `ed25519`:
    ```bash
    ssh-keygen \
      -t ed25519 \
      -f id_yc-sa-<имя_сервисной_учетной_записи>
    ```
    
    Где:
    * `-f` - относительный путь выходных файлов с закрытой и публичной частью SSH-ключа

    Результат: по заданному пути созданы 2 файла `id_yc-sa-<имя_сервисной_учетной_записи>` и `id_yc-sa-<имя_сервисной_учетной_записи>.pub`

1. Добавьте созданный SSH-ключ к сервисной учетной записи:
    ```bash
    yc organization-manager oslogin user-ssh-key create \
      --name "ssh-<имя_сервисной_учетной_записи>" \
      --expires-at <срок_действия_ключа> \
      --data <публичный_SSH-ключ> \
      --subject-id <идентификатор_сервисной_учетной_записи> \
      --organization-id <идентификатор_организации>
    ```
    Где:
    * `--organization-id` — полученный ранее идентификатор организации.
    * `--name` — имя загружаемого ключа.
    * `--subject-id` — полученный ранее [идентификатор](./users-get.md) пользователя, в профиль которого добавляется SSH-ключ.
    * `--data` — содержимое публичного SSH-ключа (`id_yc-sa-<имя_сервисной_учетной_записи>.pub`)
    * `--expires-at` — срок действия загружаемого ключа. Необязательный параметр. Позволяет установить для загружаемого ключа произвольный срок действия. Значение может задаваться в двух форматах:

        * дата окончания действия ключа в формате [ISO 8601](https://ru.wikipedia.org/wiki/ISO_8601), например, `YYYY-MM-DDT00:00:00Z`;
        * время действия ключа в часах и минутах, например `1h` или `3h30m`.

    {% note tip %}
    
    Не пренебрегайте сроком действия загружаемого ключа и организуйте его периодическую ротацию.

    {% endnote %}

    Результат:

    ```bash
    id: bpfms2eno1ka********
    subject_id: aje9okekpinr********
    data: ssh-ed25519 AAAAC3Nza_YOUR_PUBLIC_SSH_KEY_Ejal+P1sRgYA3T
    name: ssh-yc-sa-<имя_сервисной_учетной_записи>
    fingerprint: SHA256:EJQdhwWDFj4TebYQzx9CmKZHr53rNN59u0W********
    organization_id: bpf5tjj404t7********
    created_at: "2024-05-08T11:27:47.670216227Z"
    expires_at: "2024-06-08T00:00:00Z"
    ```

1. Проверьте возможность входа сервисной учетной записи на сервер:
    ```bash
    ssh yc-sa-<имя_сервисной_учетной_записи>@<IP-адрес_сервера> -i .\\id_yc-sa-<имя_сервисной_учетной_записи>
    ```
    Где:
    * `<имя_сервисной_учетной_записи>` - имя сервисной учетной записи
    * `<IP-адрес_сервера>` - IP-адрес ВМ с функцией OS Login

## Настройка Ansible {#check-ansible}

Для того чтобы убедиться что Ansible работает необходимо создать Inventory-файл и проверить его с помощью Ansible-модуля `ansible.builtin.ping`: 
1. Создайте файл `inventory.ini` с группой `yc` :
    ```ini
    [yc:vars]
    ansible_connection=ssh
    ansible_user=yc-sa-<имя_сервисной_учетной_записи>
    ansible_ssh_private_key_file=./id_yc-sa-<имя_сервисной_учетной_записи>

    [yc]
    <IP-адрес_сервера>
    ```
    Где:
    * `<имя_сервисной_учетной_записи>` - имя сервисной учетной записи
    * `<IP-адрес_сервера>` - IP-адрес ВМ с функцией OS Login

1. Запустите Ansible с модулем `ansible.builtin.ping`:
    ```bash
    ansible -i inventory.ini -m ping yc
    ```

    Результат:
    ```bash
    158.160.43.106 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
    }
    ```

Готово, далее мы можем управлять группой серверов с помощью сервисной учетной записи `ansible` с SSH-ключом ограниченного срока действия.

## Удалите созданные ресурсы {#delete-resources}

Если созданные ресурсы вам больше не нужны, удалите их:
1. Удалить SSH-ключ для пользователя `ansible`:
    ```bash
    yc organization-manager oslogin user-ssh-key delete --id <идентификатор_ключа>
    ```
    Где:
    * `--id` - идентификатор добавленного ключа